# API Testing Infrastructure

Comprehensive test suite for ScreenScraper API modules using real game data from No-Intro DAT files.

## Overview

The API test suite covers:
- **Response parsing** - XML validation and data extraction
- **Client functionality** - HTTP requests, authentication, error handling
- **Integration workflows** - End-to-end ROM → API → result flows
- **Live API testing** - Optional real API calls (requires credentials)

## Test Organization

### Test Files

- **`test_api_response_parser.py`** - Tests for XML parsing and validation
  - 40+ tests covering success, error, partial, and malformed responses
  - Uses fixture XML files from `fixtures/api/`
  
- **`test_api_client.py`** - Tests for ScreenScraperClient
  - HTTP mocking with `responses` library
  - URL construction, credential injection, rate limiting
  - Error handling for all HTTP status codes
  
- **`test_api_integration.py`** - Integration tests (marked `@pytest.mark.integration`)
  - Complete workflows from ROMInfo to game data
  - Multi-game sequences with rate limiting
  - Error recovery and name verification
  
- **`test_api_live.py`** - Live API tests (marked `@pytest.mark.live`)
  - Real ScreenScraper API calls using known game hashes
  - Requires valid `config.yaml` with credentials
  - Skipped by default - opt-in only

### Fixtures

```
tests/fixtures/api/
├── success/          # Real API responses (generated by fixture script)
├── errors/           # Error scenarios (404, 429, 430, 423, 403, 401)
├── partial/          # Partial responses (minimal metadata, no media)
├── malformed/        # Invalid XML for error testing
└── fixtures_metadata.json  # Documentation of fixture sources
```

## Running Tests

### Run all tests (excluding live):
```bash
pytest tests/test_api_*.py -v
```

### Run only live API tests:
```bash
pytest -m live -v
```

### Exclude live and integration tests:
```bash
pytest -m "not live and not integration" -v
```

### Run specific test file:
```bash
pytest tests/test_api_response_parser.py -v
```

### Run with coverage:
```bash
pytest tests/test_api_*.py --cov=curateur.api --cov-report=html
```

## Generating Fixtures

### Real API Response Fixtures

Use the fixture generator to fetch real ScreenScraper responses:

```bash
# Generate fixtures (requires config.yaml with credentials)
python tests/tools/generate_api_fixtures.py --config config.yaml

# Or specify custom output directory
python tests/tools/generate_api_fixtures.py --config config.yaml --output tests/fixtures/api
```

**Selected Games for Fixtures:**
- Super Mario Bros. (World) - Iconic, well-documented
- The Legend of Zelda (USA) - Popular action-adventure
- Final Fantasy (USA) - RPG with rich metadata
- Mega Man (USA) - Action platformer series
- '89 Dennou Kyuusei Uranai (Japan) - Obscure Japan-only
- 1942 (Japan, USA) - Small file size
- 3-D WorldRunner (USA) - Special characters in name
- 1943 Beta - Preproduction release

**Rate Limiting:** The script waits 3 seconds between requests to respect ScreenScraper rate limits.

### Fixture Metadata

Generated fixtures are documented in `fixtures_metadata.json`:
```json
{
  "generated_date": "2025-11-15",
  "source": "No-Intro Nintendo Entertainment System (Headered) DAT",
  "dat_version": "20251114-211612",
  "platform": "nes",
  "games": [
    {
      "name": "Super Mario Bros. (World)",
      "filename": "Super Mario Bros. (World).nes",
      "size": 40976,
      "crc": "3337ec46",
      "md5": "811b027eaf99c2def7b933c5208636de",
      "sha1": "ea343f4e445a9050d4b4fbac2c77d0693b1d0922",
      "fixture_file": "success/Super Mario Bros. (World).nes.xml"
    }
  ]
}
```

## Test Configuration

### pytest.ini

Custom markers defined in `pytest.ini`:
- `live` - Tests that make real API calls (opt-in)
- `integration` - Multi-component integration tests
- `slow` - Tests that take significant time

### Mock Strategy

Uses `responses` library for HTTP mocking:
- Cleaner than `unittest.mock.patch` for HTTP requests
- Declarative request/response mapping
- Automatic URL matching and parameter validation

Example:
```python
@responses.activate
def test_query_game(api_client, sample_rom_info):
    responses.add(
        responses.GET,
        'https://api.screenscraper.fr/api2/jeuInfos.php',
        body=response_xml,
        status=200
    )
    
    result = api_client.query_game(sample_rom_info)
    assert result['name'] == 'Expected Name'
```

## Test Coverage Goals

| Module | Target | Status |
|--------|--------|--------|
| response_parser.py | 95% | ✓ Complete |
| client.py | 90% | ✓ Complete |
| error_handler.py | 90% | ✓ Phase 3 |
| name_verifier.py | 95% | ✓ Phase 3 |
| rate_limiter.py | 85% | ✓ Phase 3 |
| Integration workflows | 80% | ✓ Complete |

## Known Test Data

From `nes.dat` (No-Intro 20251114-211612):

**Super Mario Bros. (World)**
- Size: 40976 bytes
- CRC: 3337ec46
- MD5: 811b027eaf99c2def7b933c5208636de
- SHA1: ea343f4e445a9050d4b4fbac2c77d0693b1d0922

**The Legend of Zelda (USA)**
- Size: 131088 bytes
- CRC: 38027b14
- MD5: d7a0f7478866538cb15b31c2935e0333
- SHA1: e83e3faa6f492ff0b8a9aa3e4c5fb0c04a8e8c87

These hashes are guaranteed to exist at ScreenScraper and can be used for reliable live testing.

## Continuous Integration

### Recommended CI Configuration

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run unit tests
        run: |
          pytest -m "not live" --cov=curateur.api --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

**Note:** Live tests should NOT run in CI without careful rate limiting consideration.

## Troubleshooting

### Import errors for `responses`

Install the test dependency:
```bash
pip install responses>=0.24.0
```

### Live tests failing

1. Verify `config.yaml` exists with valid ScreenScraper credentials
2. Check internet connectivity
3. Verify ScreenScraper API is not in maintenance mode
4. Check your API quota hasn't been exceeded

### Fixture generation fails

1. Ensure valid credentials in `config.yaml`
2. Check rate limits - script waits 3s between requests
3. Some obscure games may not be in ScreenScraper database
4. Verify DAT file paths are correct

## Future Enhancements

Potential improvements:
- [ ] Add tests for proposed throttle.py (adaptive rate limiting)
- [ ] Add tests for connection_pool.py multi-threading
- [ ] Create fixtures for more platforms (SNES, Genesis, PSX)
- [ ] Add performance benchmarks
- [ ] Mock ScreenScraper server for offline testing
- [ ] Test media downloader integration with API responses

## References

- ScreenScraper API Documentation: `reference/webapiv2.html`
- No-Intro DAT Files: `tests/fixtures/dats/no-intro/`
- Example API Response: `reference/ssfrxml.xml`
- Media Type Mapping: `reference/mediatypes.md`
